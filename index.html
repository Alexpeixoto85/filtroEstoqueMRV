<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Consulta de Imóveis - MRV</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- ESTILOS GERAIS COM PALETA MRV (VERDE) --- */
        :root {
            --primary-color: #4CAF50; /* Verde principal da MRV (similar à imagem) */
            --secondary-color: #2196F3; /* Azul complementar */
            --tertiary-color: #8BC34A; /* Verde mais claro */
            --success-color: #4CAF50; /* Manter verde para sucesso */
            --danger-color: #F44336; /* Vermelho para perigo/limpar */
            --info-color: #03A9F4; /* Azul para informação */
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-radius: 8px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        header, .config-section, .import-section, .export-section, .summary, .chart-container {
            background-color: #fff;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 15px;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo-preview {
            max-width: 150px;
            max-height: 60px;
            object-fit: contain;
        }

        .header-text {
            flex-grow: 1;
        }

        header h1 { 
            color: var(--primary-color); 
            margin: 0 0 5px 0;
            font-size: 24px;
            font-weight: 700;
        }
        
        header p {
            margin: 0;
            color: #666;
        }

        /* --- BOTÕES DE CONFIGURAÇÃO --- */
        .config-toggle {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: var(--transition);
            margin-bottom: 15px;
        }

        .config-toggle:hover {
            background-color: #1976D2; /* Tom mais escuro do azul */
        }

        .config-section {
            display: none;
        }

        .config-section.active {
            display: block;
        }

        /* --- SEÇÃO DE LOGO --- */
        .logo-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        #logoFileInput {
            flex-grow: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        #logoButton {
            background-color: var(--secondary-color);
            color: white;
        }

        #logoButton:hover {
            background-color: #1976D2;
        }

        /* --- SEÇÃO DE IMPORTAÇÃO --- */
        .import-controls { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            flex-wrap: wrap;
        }

        #csvFileInput {
            flex-grow: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            padding: 10px 15px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        #importButton { 
            background-color: var(--success-color); 
            color: white; 
        }
        #importButton:hover { 
            background-color: #388E3C; /* Tom mais escuro do verde */
        }

        #clearButton { 
            background-color: var(--danger-color); 
            color: white; 
        }
        #clearButton:hover { 
            background-color: #D32F2F; /* Tom mais escuro do vermelho */
        }

        #statusMessage {
            font-size: 14px;
            margin-top: 10px;
            color: #555;
        }

        /* --- SEÇÃO DE EXPORTAÇÃO --- */
        .export-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        #exportButton {
            background-color: var(--secondary-color);
            color: white;
        }
        
        #exportButton:hover {
            background-color: #1976D2;
        }

        /* --- SEÇÃO DE RESUMO --- */
        .summary {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .summary-item {
            flex: 1;
            min-width: 150px; /* Garante que 4 itens fiquem bem */
            padding: 15px;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--box-shadow);
            border-left: 4px solid var(--primary-color); /* Verde principal na borda */
        }
        
        .summary-item strong {
            display: block;
            margin-bottom: 5px;
            color: var(--dark-color);
            font-size: 14px;
        }

        .summary-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color); /* Verde principal no valor */
        }

        /* --- NOVO: SEÇÃO DO GRÁFICO --- */
        .chart-container {
            position: relative;
            height: 300px; /* Altura fixa para o gráfico */
        }
        
        .chart-container h3 {
             margin-top: 0;
             color: var(--dark-color);
        }
        .chart-container p {
            font-size: 14px;
            color: #666;
            margin-top: -10px;
            margin-bottom: 15px;
        }


        /* --- BARRA DE PESQUISA --- */
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-toggle {
            display: none;
            width: 100%;
            background-color: var(--primary-color); /* Verde principal */
            color: white;
            margin-bottom: 10px;
            padding: 12px;
            font-size: 16px;
            border-radius: var(--border-radius);
        }
        
        .search-bar { 
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            transition: var(--transition);
        }

        .search-bar input, .search-bar select {
            padding: 12px 15px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            -moz-appearance: textfield;
            width: 100%;
        }
        
        .search-bar input::-webkit-outer-spin-button,
        .search-bar input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* --- RESULTADOS (CARDS) --- */
        #resultsContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .property-card {
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: #fff;
            box-shadow: var(--box-shadow);
            overflow: hidden; 
            transition: var(--transition);
        }
        
        .property-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .property-card-header { 
            background-color: var(--secondary-color); /* Azul */
            color: white; 
            padding: 12px 15px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .property-card-header h3 { 
            margin: 0; 
            font-size: 18px; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        .property-card-status {
            background-color: var(--primary-color); /* Verde principal */
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .property-card-body { 
            padding: 15px; 
        }

        .property-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
        }
        .property-details strong { 
            color: #555; 
            font-weight: 600; 
        }
        .property-details span { 
            color: #111; 
            text-align: right; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .no-results {
            font-style: italic;
            color: #777;
            text-align: center;
            width: 100%;
            padding: 30px;
            background-color: #fff;
            border-radius: var(--border-radius);
            grid-column: 1 / -1;
        }
        
        .view-details-btn {
            background-color: var(--primary-color); /* Verde principal */
            color: white;
            margin-top: 15px;
            width: 100%;
            padding: 12px;
            font-size: 16px;
        }
        .view-details-btn:hover {
            background-color: #388E3C;
        }

        /* --- ESTILOS: Modal e Ficha --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            padding: 10px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 0 auto;
            padding: 20px;
            border-radius: var(--border-radius);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            width: 100%;
            max-width: 800px;
        }

        .modal-close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: black;
        }
        
        #downloadPdfButton {
            background-color: var(--primary-color); /* Verde principal */
            color: white;
            margin-top: 20px;
            width: 100%;
            padding: 12px;
            font-size: 16px;
        }
        #downloadPdfButton:hover {
            background-color: #388E3C;
        }

        /* Estilos da Ficha (dentro do modal) */
        #fichaContent {
            border: 1px solid #eee;
            background: #fff;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        .ficha-header {
            background-color: var(--secondary-color); /* Azul */
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .ficha-logo {
            max-width: 120px;
            max-height: 50px;
            object-fit: contain;
        }
        .ficha-header-text {
            flex-grow: 1;
        }
        .ficha-header h2 { 
            margin: 0; 
            font-size: 22px; 
        }
        .ficha-header p { 
            margin: 5px 0 0 0; 
            opacity: 0.9; 
            font-size: 16px; 
        }
        .ficha-status {
            background-color: var(--primary-color); /* Verde principal */
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .ficha-body { 
            padding: 20px; 
        }
        
        .ficha-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px 20px;
        }
        
        .ficha-item {
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 8px;
        }
        .ficha-item strong {
            font-size: 13px;
            color: #555;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .ficha-item span {
            font-size: 16px;
            color: #111;
            font-weight: 500;
        }
        .ficha-item-full {
            grid-column: 1 / -1;
        }

        /* -------------------------------------------
        --- RESPONSIVIDADE ---
        -------------------------------------------
        */

        /* --- Tablets (até 768px) --- */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header, .config-section, .import-section, .export-section, .summary, .chart-container {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .search-toggle {
                display: block;
            }
            
            .search-bar {
                display: none;
                grid-template-columns: 1fr 1fr;
            }
            
            .search-bar.active {
                display: grid;
            }

            #resultsContainer {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
                margin: 20px auto;
            }

            .ficha-grid {
                grid-template-columns: 1fr;
            }

            .ficha-item-full {
                grid-column: 1 / -1;
            }
            
            .import-controls, .logo-controls {
                flex-direction: column;
            }
            
            .import-controls input,
            .import-controls button,
            .logo-controls input,
            .logo-controls button {
                width: 100%;
            }
        }

        /* --- Celulares (até 480px) --- */
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }

            header, .config-section, .import-section, .export-section, .summary, .chart-container {
                padding: 12px;
            }

            header h1 {
                font-size: 20px;
            }
            
            .search-bar {
                grid-template-columns: 1fr;
            }
            
            .summary {
                flex-direction: column;
            }
            
            .summary-item {
                min-width: 100%;
            }
            
            .property-details {
                grid-template-columns: 1fr;
            }
            
            .property-details span {
                text-align: left;
            }
            
            .export-controls {
                flex-direction: column;
            }
            
            .export-controls button {
                width: 100%;
            }

            .modal-content {
                width: 100%;
                padding: 15px;
                margin: 10px auto;
            }

            .ficha-header {
                padding: 15px;
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .ficha-header h2 {
                font-size: 20px;
            }
            
            .ficha-body {
                padding: 15px;
            }
            
            .ficha-grid {
                gap: 12px;
            }
            
            .chart-container {
                height: 250px; /* Altura menor para celulares */
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-container">
                    <img id="logoPreview" class="logo-preview" src="" alt="Logo MRV" style="display: none;">
                </div>
                <div class="header-text">
                    <h1>Sistema de Consulta de Imóveis - MRV</h1>
                    <p>Consulta e filtragem de imóveis disponíveis.</p>
                </div>
            </div>
        </header>

        <button class="config-toggle" id="configToggle">Configurações do Sistema</button>

        <div class="config-section" id="configSection">
            <div class="logo-section">
                <h3>Logo da Construtora</h3>
                <p>Carregue a logo da MRV para exibição no sistema e nas fichas PDF.</p>
                <div class="logo-controls">
                    <input type="file" id="logoFileInput" accept="image/*">
                    <button id="logoButton">Carregar Logo</button>
                </div>
                <div id="logoStatusMessage"></div>
            </div>

            <div class="import-section">
                <h3>Importar Dados</h3>
                <p>Selecione um arquivo <strong>.csv, .xls ou .xlsx</strong> para importar ou atualizar os dados.</p>
                <div class="import-controls">
                    <input type="file" id="csvFileInput" accept=".csv, .xls, .xlsx, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
                    <button id="importButton">Importar</button>
                    <button id="clearButton">Limpar Dados Salvos</button>
                </div>
                <div id="statusMessage"></div>
            </div>

            <div class="export-section">
                <h3>Exportar Dados</h3>
                <p>Exporte os dados filtrados para um arquivo CSV.</p>
                <div class="export-controls">
                    <button id="exportButton">Exportar CSV</button>
                </div>
            </div>
        </div>

        <div class="summary" id="summaryContainer">
            </div>
        
        <div class="chart-container">
            <h3>Imóveis por Regional</h3>
            <p>Quantidade de unidades agrupadas por regional ou cidade.</p>
            <canvas id="empreendimentoChart"></canvas>
        </div>


        <div class="search-container">
            <button class="search-toggle" id="searchToggle">Mostrar Filtros</button>
            <div class="search-bar" id="searchBar">
                <input type="text" id="searchUnidade" placeholder="Pesquisar por Unidade...">
                <select id="searchCidade">
                    <option value="">Todas as Cidades</option>
                </select>
                <select id="searchTipologia">
                    <option value="">Todas as Tipologias</option>
                </select>
                <select id="searchStatus">
                    <option value="">Todos os Status</option>
                </select>
                <input type="number" id="searchValorMin" placeholder="Valor Mín. (R$)...">
                <input type="number" id="searchValorMax" placeholder="Valor Máx. (R$)...">
                <input type="number" id="searchAreaMin" placeholder="Área Mín. (m²)...">
                <input type="number" id="searchAreaMax" placeholder="Área Máx. (m²)...">
            </div>
        </div>

        <div id="resultsContainer">
            </div>
    </div>

    <div id="modalContainer" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="modalClose">&times;</span>
            
            <div id="fichaContent">
                </div>
            
            <button id="downloadPdfButton">Baixar PDF da Ficha</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Elementos da página
            const searchUnidadeInput = document.getElementById('searchUnidade');
            const searchCidadeSelect = document.getElementById('searchCidade');
            const searchTipologiaSelect = document.getElementById('searchTipologia');
            const searchStatusSelect = document.getElementById('searchStatus');
            const searchValorMinInput = document.getElementById('searchValorMin');
            const searchValorMaxInput = document.getElementById('searchValorMax');
            const searchAreaMinInput = document.getElementById('searchAreaMin');
            const searchAreaMaxInput = document.getElementById('searchAreaMax');
            const resultsContainer = document.getElementById('resultsContainer');
            const summaryContainer = document.getElementById('summaryContainer');
            const csvFileInput = document.getElementById('csvFileInput');
            const importButton = document.getElementById('importButton');
            const clearButton = document.getElementById('clearButton');
            const exportButton = document.getElementById('exportButton');
            const statusMessage = document.getElementById('statusMessage');
            const searchToggle = document.getElementById('searchToggle');
            const searchBar = document.getElementById('searchBar');

            // Elementos do Logo
            const logoFileInput = document.getElementById('logoFileInput');
            const logoButton = document.getElementById('logoButton');
            const logoPreview = document.getElementById('logoPreview');
            const logoStatusMessage = document.getElementById('logoStatusMessage');

            // Elementos de Configuração
            const configToggle = document.getElementById('configToggle');
            const configSection = document.getElementById('configSection');

            // Elementos do Modal
            const modalContainer = document.getElementById('modalContainer');
            const modalClose = document.getElementById('modalClose');
            const fichaContent = document.getElementById('fichaContent');
            const downloadPdfButton = document.getElementById('downloadPdfButton');

            // Banco de dados em memória
            let databaseImoveis = [];
            let myChart = null; // Variável global para o gráfico
            const STORAGE_KEY = 'sistemaImoveisData';
            const LOGO_STORAGE_KEY = 'sistemaImoveisLogo';
            
            // Referências às bibliotecas externas
            const { jsPDF } = window.jspdf;
            const XLSX = window.XLSX; 

            // --- FUNÇÕES DE UTILIDADE ---

            function removerAcentos(texto) {
                if (!texto) return '';
                return String(texto).normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            }

            function normalizarTexto(texto) {
                return removerAcentos(texto).toLowerCase().trim();
            }

            // Função específica para limpar valores monetários
            function limparValorMonetario(valor) {
                if (typeof valor === 'number') return valor;
                if (typeof valor !== 'string') return valor;
                
                let valorString = String(valor);
                
                valorString = valorString
                    .replace('R$', '')
                    .replace(/[^\d,.]/g, '')
                    .trim();
                
                if (valorString.includes('.') && valorString.includes(',')) {
                    valorString = valorString.replace(/\./g, '').replace(',', '.');
                } 
                else if (valorString.includes(',') && !valorString.includes('.')) {
                    valorString = valorString.replace(',', '.');
                }
                
                const numero = parseFloat(valorString);
                return isNaN(numero) ? valor : numero;
            }
            
            // Função específica para limpar valores de área
            function limparValorArea(valor) {
                if (typeof valor === 'number') return valor;
                if (typeof valor !== 'string') return valor;
                
                let valorString = String(valor);
                
                valorString = valorString
                    .replace('m²', '')
                    .replace('m', '')
                    .replace(/[^\d,.]/g, '')
                    .trim();
                
                valorString = valorString.replace(',', '.');
                
                const numero = parseFloat(valorString);
                return isNaN(numero) ? valor : numero;
            }
            
            function formatarMoeda(valor) {
                const numero = parseFloat(valor);
                if (isNaN(numero)) return 'R$ 0,00';
                return numero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }
            
            function formatarArea(valor) {
                const numero = parseFloat(valor);
                if (isNaN(numero)) return '0 m²';
                
                const numeroFormatado = numero.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                return `${numeroFormatado} m²`;
            }

            // --- FUNÇÕES DE CONFIGURAÇÃO ---

            configToggle.addEventListener('click', () => {
                configSection.classList.toggle('active');
                configToggle.textContent = configSection.classList.contains('active') ? 
                    'Ocultar Configurações' : 'Configurações do Sistema';
            });

            // --- FUNÇÕES DE LOGO ---

            function loadLogoFromStorage() {
                const logoData = localStorage.getItem(LOGO_STORAGE_KEY);
                if (logoData) {
                    logoPreview.src = logoData;
                    logoPreview.style.display = 'block';
                    logoStatusMessage.textContent = 'Logo carregada do armazenamento local.';
                } else {
                    logoStatusMessage.textContent = 'Nenhuma logo carregada. Por favor, carregue uma logo.';
                }
            }

            logoButton.addEventListener('click', () => {
                const file = logoFileInput.files[0];
                if (!file) {
                    alert('Por favor, selecione um arquivo de imagem primeiro.');
                    return;
                }

                if (!file.type.match('image.*')) {
                    alert('Por favor, selecione um arquivo de imagem válido (JPG, PNG, etc.).');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    const logoData = event.target.result;
                    localStorage.setItem(LOGO_STORAGE_KEY, logoData);
                    logoPreview.src = logoData;
                    logoPreview.style.display = 'block';
                    logoStatusMessage.textContent = 'Logo carregada com sucesso!';
                };
                reader.readAsDataURL(file);
            });

            // --- FUNÇÕES DE DADOS (IMPORTAR, SALVAR, LIMPAR) ---

            function loadDataFromStorage() {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    databaseImoveis = JSON.parse(data);
                    statusMessage.textContent = `${databaseImoveis.length} imóveis carregados do banco de dados local.`;
                    updateFilterOptions();
                    filterImoveis();
                    updateSummary();
                    updateChart(); // Atualiza o gráfico
                } else {
                    statusMessage.textContent = 'Nenhum dado local encontrado. Por favor, importe um arquivo CSV ou Excel.';
                }
            }

            clearButton.addEventListener('click', () => {
                if (confirm('Tem certeza que deseja apagar todos os dados de imóveis salvos?')) {
                    localStorage.removeItem(STORAGE_KEY);
                    databaseImoveis = [];
                    filterImoveis();
                    updateSummary();
                    updateChart(); // Limpa o gráfico
                    statusMessage.textContent = 'Dados locais apagados. Importe um novo arquivo.';
                }
            });

            // --- LÓGICA DE IMPORTAÇÃO (CSV E EXCEL) ---

            importButton.addEventListener('click', () => {
                const file = csvFileInput.files[0];
                if (!file) {
                    alert('Por favor, selecione um arquivo primeiro.');
                    return;
                }

                const reader = new FileReader();
                const fileName = file.name.toLowerCase();

                if (fileName.endsWith('.csv')) {
                    reader.onload = (event) => {
                        const text = event.target.result;
                        processCSV(text); 
                    };
                    reader.readAsText(file, "ISO-8859-1"); 
                
                } else if (fileName.endsWith('.xls') || fileName.endsWith('.xlsx')) {
                    reader.onload = (event) => {
                        const data = event.target.result;
                        processExcel(data); 
                    };
                    reader.readAsArrayBuffer(file);
                
                } else {
                    alert('Formato de arquivo não suportado. Use .csv, .xls ou .xlsx.');
                }
            });

            function processExcel(data) {
                try {
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    const rawDataList = XLSX.utils.sheet_to_json(worksheet, { 
                        raw: true, // Garante que números sejam lidos como números
                        defval: "" 
                    });

                    processAndLoadData(rawDataList);

                } catch (error) {
                    console.error('Erro ao processar o arquivo Excel:', error);
                    statusMessage.textContent = 'Erro ao ler o arquivo Excel. Verifique o formato.';
                }
            }
            
            function processCSV(csvText) {
                const lines = csvText.split(/\r\n|\n/);
                if (lines.length < 2) {
                    statusMessage.textContent = 'Erro: CSV vazio ou inválido.';
                    return;
                }
                
                const headers = lines[0].split(';').map(h => h.trim());
                
                const rawDataList = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const data = lines[i].split(';');
                    const rowObject = {};
                    
                    headers.forEach((header, index) => {
                        if (header) { 
                            rowObject[header] = data[index] ? data[index].trim() : '';
                        }
                    });
                    
                    if (Object.keys(rowObject).length > 0) {
                        rawDataList.push(rowObject);
                    }
                }
                
                processAndLoadData(rawDataList);
            }

            // --- MAPEAMENTO FLEXÍVEL DE COLUNAS ---
            
            function createFlexibleHeaderMap(aliasConfig) {
                const map = {};
                for (const internalKey in aliasConfig) {
                    const aliases = aliasConfig[internalKey];
                    for (const alias of aliases) {
                        map[alias] = internalKey;
                    }
                }
                return map;
            }

            function processAndLoadData(rawDataList) {
                
                const standardFieldAliases = {
                    'unidade': ['unidade', 'imovel', 'apartamento', 'apto', 'bloco/apto', 'identificacao'],
                    'cidade': ['cidade', 'municipio', 'praca'],
                    'regional': ['regional', 'regiao'],
                    'status': ['status da unidade', 'status', 'disponibilidade', 'disponivel'],
                    'tipologia': ['tipologia', 'tipo', 'planta', 'layout'],
                    'valorImovel': ['valor do imovel', 'valor', 'preco', 'valor tabela', 'preco de venda', 'valor total'],
                    'valorAvaliacao': ['valor da avaliacao', 'avaliacao', 'valor avaliacao', 'laudo'],
                    'bomPagador': ['bom pagador total', 'bom pagador', 'desconto bom pagador', 'desconto'],
                    'bonus': ['bonus', 'bonificacao'],
                    'areaInterna': ['area interna', 'area util', 'area m2', 'area', 'm2', 'metragem'],
                    'areaQuintal': ['area do quintal', 'quintal', 'area externa', 'area descoberta'],
                    'areaVaranda': ['area da varanda', 'varanda', 'sacada'],
                    'vagasCarro': ['vagas carro', 'vaga carro', 'vagas garagem', 'vaga', 'vagas'],
                    'vagasMoto': ['vagas moto', 'vaga moto'],
                    'ladoNascente': ['lado nascente', 'nascente', 'posicao sol', 'sol'],
                    'tipoAcabamento': ['tipo de acabamento', 'acabamento', 'padrao acabamento'],
                    'pagadoria': ['pagadoria'],
                    'versaoTabela': ['versao da tabela', 'tabela', 'versao'],
                    'oportunidades': ['oportunidades abertas', 'oportunidades']
                };
                
                const headerMapping = createFlexibleHeaderMap(standardFieldAliases);
                
                const camposTexto = ['regional', 'cidade', 'unidade', 'ladoNascente', 'tipologia', 'tipoAcabamento', 'status', 'pagadoria'];
                const camposNumericosInteiros = ['vagasCarro', 'vagasMoto'];
                const camposMonetarios = ['valorImovel', 'valorAvaliacao', 'bomPagador', 'bonus'];
                const camposArea = ['areaInterna', 'areaQuintal', 'areaVaranda'];
                
                const newData = [];

                for (const rawRow of rawDataList) {
                    const imovel = {};
                    
                    for (const headerKey in rawRow) {
                        const normalizedHeader = normalizarTexto(headerKey);
                        const internalKey = headerMapping[normalizedHeader]; 
                        
                        if (internalKey) {
                            let value = rawRow[headerKey];
                            
                            if (camposTexto.includes(internalKey)) {
                                value = removerAcentos(String(value)); 
                            } 
                            else if (camposMonetarios.includes(internalKey)) {
                                value = limparValorMonetario(value);
                            } else if (camposArea.includes(internalKey)) {
                                value = limparValorArea(value);
                            } else if (camposNumericosInteiros.includes(internalKey)) {
                                value = parseInt(value) || 0; 
                            } else {
                                value = String(value);
                            }
                            
                            imovel[internalKey] = value;
                        }
                    }

                    if (imovel.unidade) {
                        newData.push(imovel);
                    }
                }

                if (newData.length > 0) {
                    databaseImoveis = newData;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(databaseImoveis));
                    statusMessage.textContent = `Sucesso! ${databaseImoveis.length} imóveis importados e salvos localmente.`;
                    updateFilterOptions();
                    filterImoveis();
                    updateSummary();
                    updateChart(); // Atualiza o gráfico
                } else {
                    statusMessage.textContent = 'Erro: Nenhum dado válido encontrado no arquivo. Verifique se o formato está correto e se existe uma coluna que possa ser identificada como "unidade".';
                }
            }

            // --- FIM DA LÓGICA DE IMPORTAÇÃO ---

            function updateFilterOptions() {
                searchCidadeSelect.innerHTML = '<option value="">Todas as Cidades</option>';
                searchTipologiaSelect.innerHTML = '<option value="">Todas as Tipologias</option>';
                searchStatusSelect.innerHTML = '<option value="">Todos os Status</option>';
                
                const cidades = [...new Set(databaseImoveis.map(imovel => imovel.cidade))].sort();
                const tipologias = [...new Set(databaseImoveis.map(imovel => imovel.tipologia))].sort();
                const status = [...new Set(databaseImoveis.map(imovel => imovel.status))].sort();
                
                cidades.forEach(cidade => {
                    if(cidade) { // Evita opções vazias
                        const option = document.createElement('option');
                        option.value = cidade;
                        option.textContent = cidade;
                        searchCidadeSelect.appendChild(option);
                    }
                });
                
                tipologias.forEach(tipologia => {
                    if(tipologia) {
                        const option = document.createElement('option');
                        option.value = tipologia;
                        option.textContent = tipologia;
                        searchTipologiaSelect.appendChild(option);
                    }
                });
                
                status.forEach(estado => {
                    if(estado) {
                        const option = document.createElement('option');
                        option.value = estado;
                        option.textContent = estado;
                        searchStatusSelect.appendChild(option);
                    }
                });
            }

            // --- MODIFICADO: updateSummary ---
            function updateSummary() {
                const totalImoveis = databaseImoveis.length;
                const imoveisDisponiveis = databaseImoveis.filter(imovel => 
                    imovel.status && normalizarTexto(imovel.status) === 'disponivel'
                ).length;
                
                // NOVO CÁLCULO: Valor Total
                const valorTotal = databaseImoveis.reduce((sum, imovel) => 
                        sum + (parseFloat(imovel.valorImovel) || 0), 0);
                
                const valorMedio = totalImoveis > 0 ? 
                    valorTotal / totalImoveis
                    : 0;
                
                // ATUALIZADO: Adicionado card de Valor Total
                summaryContainer.innerHTML = `
                    <div class="summary-item">
                        <strong>Total de Imóveis</strong>
                        <div class="summary-value">${totalImoveis}</div>
                    </div>
                    <div class="summary-item">
                        <strong>Imóveis Disponíveis</strong>
                        <div class="summary-value">${imoveisDisponiveis}</div>
                    </div>
                    <div class="summary-item">
                        <strong>Valor Total (R$)</strong>
                        <div class="summary-value">${formatarMoeda(valorTotal)}</div>
                    </div>
                    <div class="summary-item">
                        <strong>Valor Médio (R$)</strong>
                        <div class="summary-value">${formatarMoeda(valorMedio)}</div>
                    </div>
                `;
            }

            // --- NOVO: updateChart ---
            function updateChart() {
                const ctx = document.getElementById('empreendimentoChart').getContext('2d');

                // 1. Agrupar dados por 'regional' ou 'cidade'
                const countsByRegional = databaseImoveis.reduce((acc, imovel) => {
                    // Tenta usar 'regional', se não tiver, usa 'cidade'
                    let regionalKey = imovel.regional || imovel.cidade || 'N/D';
                    
                    if (regionalKey === 'N/D' || regionalKey === '') {
                        regionalKey = 'Sem Grupo';
                    }

                    acc[regionalKey] = (acc[regionalKey] || 0) + 1;
                    return acc;
                }, {});

                // 2. Preparar dados para o gráfico
                const labels = Object.keys(countsByRegional).sort();
                const data = labels.map(label => countsByRegional[label]);

                // 3. Destruir gráfico antigo se existir
                if (myChart) {
                    myChart.destroy();
                }

                // 4. Criar novo gráfico
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Qtd. de Imóveis',
                            data: data,
                            backgroundColor: [ // Usar cores da paleta
                                'rgba(76, 175, 80, 0.7)',  /* --primary-color */
                                'rgba(33, 150, 243, 0.7)', /* --secondary-color */
                                'rgba(139, 195, 74, 0.7)', /* --tertiary-color */
                                'rgba(255, 152, 0, 0.7)',  
                                'rgba(156, 39, 176, 0.7)'
                            ],
                            borderColor: [
                                'rgba(76, 175, 80, 1)',
                                'rgba(33, 150, 243, 1)',
                                'rgba(139, 195, 74, 1)',
                                'rgba(255, 152, 0, 1)',
                                'rgba(156, 39, 176, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    // Garante que os ticks sejam números inteiros
                                    stepSize: 1, 
                                    callback: function(value) { if (value % 1 === 0) { return value; } }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false // Oculta a legenda (só há 1 dataset)
                            }
                        }
                    }
                });
            }

            // --- FUNÇÕES DE FILTRO E EXIBIÇÃO ---

            function displayResults(imoveis) {
                resultsContainer.innerHTML = ''; 

                if (imoveis.length === 0) {
                    resultsContainer.innerHTML = '<p class="no-results">Nenhum imóvel encontrado para esta combinação de filtros.</p>';
                    return;
                }

                imoveis.forEach(imovel => {
                    const valorImovelFmt = formatarMoeda(imovel.valorImovel);
                    const valorAvaliacaoFmt = formatarMoeda(imovel.valorAvaliacao);
                    
                    const card = document.createElement('div');
                    card.className = 'property-card';
                    
                    card.innerHTML = `
                        <div class="property-card-header">
                            <h3>${imovel.unidade}</h3>
                            <div class="property-card-status">${imovel.status || 'N/D'}</div>
                        </div>
                        <div class="property-card-body">
                            <div class="property-details">
                                <strong>Cidade:</strong>
                                <span>${imovel.cidade || 'N/D'}</span>
                                
                                <strong>Tipologia:</strong>
                                <span>${imovel.tipologia || 'N/D'}</span>

                                <strong>Área Interna:</strong>
                                <span>${formatarArea(imovel.areaInterna)}</span>
                                
                                <strong>Valor do Imóvel:</strong>
                                <span>${valorImovelFmt}</span>
                                
                                <strong>Valor da Avaliação:</strong>
                                <span>${valorAvaliacaoFmt}</span>
                            </div>
                            
                            <button class="view-details-btn" data-id="${imovel.unidade}">Ver Ficha Completa</button>
                        </div>
                    `;
                    resultsContainer.appendChild(card);
                });
            }

            function filterImoveis() {
                const filteredImoveis = getFilteredImoveis();
                displayResults(filteredImoveis);
            }

            // --- FUNÇÕES DE EXPORTAÇÃO ---

            function exportToCSV() {
                if (databaseImoveis.length === 0) {
                    alert('Não há dados para exportar.');
                    return;
                }

                const filteredImoveis = getFilteredImoveis();
                
                if (filteredImoveis.length === 0) {
                    alert('Não há dados filtrados para exportar.');
                    return;
                }

                const headers = [
                    'Regional', 'Cidade', 'Unidade', 'Lado Nascente', 'Tipologia',
                    'Área interna', 'Área do quintal', 'Área da varanda', 'Tipo de acabamento',
                    'Status da unidade', 'Valor do Imóvel', 'Vagas Carro', 'Vagas Moto',
                    'Valor da Avaliação', 'Bom Pagador Total', 'Pagadoria', 'Bônus',
                    'Versao da Tabela', 'Oportunidades abertas'
                ];

                let csvContent = headers.join(';') + '\n';
                
                filteredImoveis.forEach(imovel => {
                    const row = [
                        imovel.regional || '',
                        imovel.cidade || '',
                        imovel.unidade || '',
                        imovel.ladoNascente || '',
                        imovel.tipologia || '',
                        imovel.areaInterna || '',
                        imovel.areaQuintal || '',
                        imovel.areaVaranda || '',
                        imovel.tipoAcabamento || '',
                        imovel.status || '',
                        imovel.valorImovel || '',
                        imovel.vagasCarro || '',
                        imovel.vagasMoto || '',
                        imovel.valorAvaliacao || '',
                        imovel.bomPagador || '',
                        imovel.pagadoria || '',
                        imovel.bonus || '',
                        imovel.versaoTabela || '',
                        imovel.oportunidades || ''
                    ];
                    csvContent += row.join(';') + '\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'imoveis_filtrados.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function getFilteredImoveis() {
                const unidadeQuery = normalizarTexto(searchUnidadeInput.value);
                const cidadeQuery = searchCidadeSelect.value;
                const tipologiaQuery = searchTipologiaSelect.value;
                const statusQuery = searchStatusSelect.value;
                const minValor = parseFloat(searchValorMinInput.value) || 0;
                const maxValor = parseFloat(searchValorMaxInput.value) || Infinity;
                const minArea = parseFloat(searchAreaMinInput.value) || 0;
                const maxArea = parseFloat(searchAreaMaxInput.value) || Infinity;

                if (databaseImoveis.length === 0) {
                    return [];
                }

                return databaseImoveis.filter(imovel => {
                    const valorImovel = parseFloat(imovel.valorImovel) || 0;
                    const areaInterna = parseFloat(imovel.areaInterna) || 0;
                    
                    const matchesUnidade = imovel.unidade && normalizarTexto(imovel.unidade).includes(unidadeQuery);
                    const matchesCidade = !cidadeQuery || imovel.cidade === cidadeQuery;
                    const matchesTipologia = !tipologiaQuery || imovel.tipologia === tipologiaQuery;
                    const matchesStatus = !statusQuery || imovel.status === statusQuery;
                    const matchesValor = valorImovel >= minValor && valorImovel <= maxValor;
                    const matchesArea = areaInterna >= minArea && areaInterna <= maxArea;
                    
                    return matchesUnidade && matchesCidade && matchesTipologia && matchesStatus && matchesValor && matchesArea;
                });
            }

            // --- FUNÇÕES: MODAL E PDF ---

            function openModal(unidadeId) {
                const imovel = databaseImoveis.find(imv => imv.unidade === unidadeId);
                if (!imovel) {
                    alert('Erro: Imóvel não encontrado.');
                    return;
                }

                const logoData = localStorage.getItem(LOGO_STORAGE_KEY);
                const logoHtml = logoData ? `<img src="${logoData}" class="ficha-logo" alt="Logo MRV">` : '';

                fichaContent.innerHTML = `
                    <div class="ficha-header">
                        ${logoHtml}
                        <div class="ficha-header-text">
                            <h2>${imovel.unidade}</h2>
                            <p>${imovel.tipologia || 'N/D'} - ${imovel.cidade || 'N/D'}</p>
                        </div>
                        <div class="ficha-status">${imovel.status || 'N/D'}</div>
                    </div>
                    <div class="ficha-body">
                        <div class="ficha-grid">
                            <div class="ficha-item">
                                <strong>Valor do Imóvel</strong>
                                <span>${formatarMoeda(imovel.valorImovel)}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Valor da Avaliação</strong>
                                <span>${formatarMoeda(imovel.valorAvaliacao)}</span>
                            </div>

                            <div class="ficha-item">
                                <strong>Área Interna</strong>
                                <span>${formatarArea(imovel.areaInterna)}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Área do Quintal</strong>
                                <span>${formatarArea(imovel.areaQuintal)}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Área da Varanda</strong>
                                <span>${formatarArea(imovel.areaVaranda)}</span>
                            </div>
                            
                            <div class="ficha-item">
                                <strong>Regional</strong>
                                <span>${imovel.regional || 'N/D'}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Lado Nascente</strong>
                                <span>${imovel.ladoNascente || 'N/D'}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Acabamento</strong>
                                <span>${imovel.tipoAcabamento || 'N/D'}</span>
                            </div>
                            
                            <div class="ficha-item">
                                <strong>Vagas Carro</strong>
                                <span>${imovel.vagasCarro || 'N/D'}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Vagas Moto</strong>
                                <span>${imovel.vagasMoto || 'N/D'}</span>
                            </div>
                            
                            <div class="ficha-item">
                                <strong>Bom Pagador</strong>
                                <span>${formatarMoeda(imovel.bomPagador)}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Pagadoria</strong>
                                <span>${imovel.pagadoria || 'N/D'}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Bônus</strong>
                                <span>${formatarMoeda(imovel.bonus)}</span>
                            </div>
                            
                            <div class="ficha-item">
                                <strong>Versão da Tabela</strong>
                                <span>${imovel.versaoTabela || 'N/D'}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Oportunidades</strong>
                                <span>${imovel.oportunidades || 'N/D'}</span>
                            </div>
                        </div>
                    </div>
                `;

                modalContainer.style.display = 'block';
                
                downloadPdfButton.onclick = () => downloadPdf(imovel);
            }

            function closeModal() {
                modalContainer.style.display = 'none';
            }

            // PDF (Usando a versão melhorada da última interação)
            function downloadPdf(imovel) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15; 
                const contentWidth = pageWidth - 2 * margin;
                
                const colorPrimary = [76, 175, 80]; // Verde Principal (#4CAF50)
                const colorSecondary = [33, 150, 243]; // Azul Secundário (#2196F3)
                const colorTertiary = [139, 195, 74]; // Verde Claro (#8BC34A)
                const colorDanger = [244, 67, 54]; // Vermelho (#F44336)
                
                doc.setDrawColor(200, 200, 200); 
                doc.setLineWidth(0.5);
                doc.rect(5, 5, pageWidth - 10, pageHeight - 10); 
                
                doc.setFillColor(...colorPrimary);
                doc.rect(margin - 1, 10, contentWidth + 2, 50, 'F'); 
                
                const logoData = localStorage.getItem(LOGO_STORAGE_KEY);
                if (logoData) {
                    try {
                        doc.addImage(logoData, 'PNG', margin + 5, 15, 40, 30);
                    } catch (e) {
                        console.error('Erro ao adicionar logo ao PDF:', e);
                    }
                }
                
                const textX = logoData ? margin + 50 : margin + 5;
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('FICHA DO IMÓVEL', textX, 28);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('Sistema de Consulta de Imóveis - MRV', textX, 38);
                
                let yPosition = 75; 

                // BLOCO 1: INFORMAÇÕES PRINCIPAIS (Verde Claro)
                const blockHeaderHeight = 10;
                doc.setFillColor(...colorTertiary);
                doc.roundedRect(margin, yPosition, contentWidth, blockHeaderHeight, 3, 0, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(11);
                doc.text('INFORMAÇÕES PRINCIPAIS', margin + 5, yPosition + 7);
                
                // NOVO LOCAL DO STATUS (DENTRO DO BLOCO 1)
                const statusText = imovel.status || 'N/D';
                const isDisponivel = imovel.status && normalizarTexto(imovel.status) === 'disponivel';
                const statusColor = isDisponivel ? colorPrimary : colorDanger; 
                
                const statusBadgeWidth = 50;
                const statusBadgeHeight = blockHeaderHeight; 
                const statusBadgeX = (margin + contentWidth) - statusBadgeWidth; 
                const statusBadgeY = yPosition; 

                doc.setFillColor(...statusColor);
                doc.roundedRect(statusBadgeX, statusBadgeY, statusBadgeWidth, statusBadgeHeight, 0, 3, 'F'); 
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text(statusText, statusBadgeX + (statusBadgeWidth / 2), statusBadgeY + (statusBadgeHeight / 2) + 3, { align: 'center' });

                yPosition += blockHeaderHeight; 
                
                // Conteúdo do Bloco 1
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                yPosition += 12; 
                const splitLines = doc.splitTextToSize(imovel.unidade, contentWidth - 10);
                doc.text(splitLines, margin + 5, yPosition);
                yPosition += (splitLines.length * 6); 
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`${imovel.tipologia || 'N/D'} - ${imovel.cidade || 'N/D'}`, margin + 5, yPosition);
                yPosition += 15; 

                
                // BLOCO 2: VALORES (Azul)
                doc.setFillColor(...colorSecondary);
                doc.roundedRect(margin, yPosition, contentWidth, blockHeaderHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(11);
                doc.text('VALORES', margin + 5, yPosition + 7);
                yPosition += blockHeaderHeight;
                
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                yPosition += 10;
                doc.text(`Valor do Imóvel: ${formatarMoeda(imovel.valorImovel)}`, margin + 5, yPosition);
                doc.text(`Valor da Avaliação: ${formatarMoeda(imovel.valorAvaliacao)}`, pageWidth / 2, yPosition);
                yPosition += 7;
                doc.text(`Bom Pagador: ${formatarMoeda(imovel.bomPagador)}`, margin + 5, yPosition);
                yPosition += 15;

                // BLOCO 3: ÁREAS (Azul)
                doc.setFillColor(...colorSecondary);
                doc.roundedRect(margin, yPosition, contentWidth, blockHeaderHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(11);
                doc.text('ÁREAS (m²)', margin + 5, yPosition + 7);
                yPosition += blockHeaderHeight;
                
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                yPosition += 10;
                doc.text(`Área Interna: ${formatarArea(imovel.areaInterna)}`, margin + 5, yPosition);
                doc.text(`Área do Quintal: ${formatarArea(imovel.areaQuintal)}`, pageWidth / 2, yPosition);
                yPosition += 7;
                doc.text(`Área da Varanda: ${formatarArea(imovel.areaVaranda)}`, margin + 5, yPosition);
                yPosition += 15;

                // BLOCO 4: CARACTERÍSTICAS (Azul)
                doc.setFillColor(...colorSecondary);
                doc.roundedRect(margin, yPosition, contentWidth, blockHeaderHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(11);
                doc.text('CARACTERÍSTICAS', margin + 5, yPosition + 7);
                yPosition += blockHeaderHeight;
                
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                yPosition += 10;
                doc.text(`Regional: ${imovel.regional || 'N/D'}`, margin + 5, yPosition);
                doc.text(`Lado Nascente: ${imovel.ladoNascente || 'N/D'}`, pageWidth / 2, yPosition);
                yPosition += 7;
                doc.text(`Acabamento: ${imovel.tipoAcabamento || 'N/D'}`, margin + 5, yPosition);
                doc.text(`Vagas Carro: ${imovel.vagasCarro || 'N/D'}`, pageWidth / 2, yPosition);
                yPosition += 7;
                doc.text(`Vagas Moto: ${imovel.vagasMoto || 'N/D'}`, margin + 5, yPosition);
                yPosition += 15;

                // BLOCO 5: INFORMAÇÕES ADICIONAIS (Azul)
                doc.setFillColor(...colorSecondary);
                doc.roundedRect(margin, yPosition, contentWidth, blockHeaderHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(11);
                doc.text('INFORMAÇÕES ADICIONAIS', margin + 5, yPosition + 7);
                yPosition += blockHeaderHeight;
                
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                yPosition += 10;
                doc.text(`Pagadoria: ${imovel.pagadoria || 'N/D'}`, margin + 5, yPosition);
                doc.text(`Bônus: ${formatarMoeda(imovel.bonus)}`, pageWidth / 2, yPosition);
                yPosition += 7;
                doc.text(`Versão da Tabela: ${imovel.versaoTabela || 'N/D'}`, margin + 5, yPosition);
                doc.text(`Oportunidades: ${imovel.oportunidades || 'N/D'}`, pageWidth / 2, yPosition);
                
                
                // RODAPÉ
                const data = new Date().toLocaleDateString('pt-BR');
                const hora = new Date().toLocaleTimeString('pt-BR');
                
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                doc.text(`Gerado em: ${data} às ${hora}`, margin, pageHeight - 10);
                doc.text('Sistema de Consulta de Imóveis - MRV', pageWidth - margin, pageHeight - 10, { align: 'right' });
                
                doc.save(`ficha_imovel_${imovel.unidade}.pdf`);
            }


            // --- EVENT LISTENERS ---

            // Filtros
            searchUnidadeInput.addEventListener('input', filterImoveis);
            searchCidadeSelect.addEventListener('change', filterImoveis);
            searchTipologiaSelect.addEventListener('change', filterImoveis);
            searchStatusSelect.addEventListener('change', filterImoveis);
            searchValorMinInput.addEventListener('input', filterImoveis);
            searchValorMaxInput.addEventListener('input', filterImoveis);
            searchAreaMinInput.addEventListener('input', filterImoveis);
            searchAreaMaxInput.addEventListener('input', filterImoveis);

            // Exportação
            exportButton.addEventListener('click', exportToCSV);

            // Modal
            modalClose.addEventListener('click', closeModal);
            window.addEventListener('click', (event) => {
                if (event.target === modalContainer) {
                    closeModal();
                }
            });

            // Event delegation para botões "Ver Ficha Completa"
            resultsContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('view-details-btn')) {
                    const unidadeId = event.target.getAttribute('data-id');
                    openModal(unidadeId);
                }
            });

            // Toggle para filtros em mobile
            searchToggle.addEventListener('click', () => {
                searchBar.classList.toggle('active');
                searchToggle.textContent = searchBar.classList.contains('active') ? 
                    'Ocultar Filtros' : 'Mostrar Filtros';
            });

            // Carregar dados ao iniciar
            loadDataFromStorage();
            loadLogoFromStorage();
        });
    </script>
</body>
</html>
