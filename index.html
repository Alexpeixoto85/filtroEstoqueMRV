<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Consulta de Imóveis - MRV</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* --- ESTILOS GERAIS COM PALETA MRV --- */
        :root {
            --primary-color: #E30613; /* Vermelho MRV */
            --secondary-color: #0056A4; /* Azul MRV */
            --tertiary-color: #FFC107; /* Amarelo MRV */
            --success-color: #28a745;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-radius: 8px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        header, .config-section, .import-section, .export-section, .summary {
            background-color: #fff;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 15px;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo-preview {
            max-width: 150px;
            max-height: 60px;
            object-fit: contain;
        }

        .header-text {
            flex-grow: 1;
        }

        header h1 { 
            color: var(--primary-color); 
            margin: 0 0 5px 0;
            font-size: 24px;
            font-weight: 700;
        }
        
        header p {
            margin: 0;
            color: #666;
        }

        /* --- BOTÕES DE CONFIGURAÇÃO --- */
        .config-toggle {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: var(--transition);
            margin-bottom: 15px;
        }

        .config-toggle:hover {
            background-color: #004080;
        }

        .config-section {
            display: none;
        }

        .config-section.active {
            display: block;
        }

        /* --- SEÇÃO DE LOGO --- */
        .logo-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        #logoFileInput {
            flex-grow: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        #logoButton {
            background-color: var(--secondary-color);
            color: white;
        }

        #logoButton:hover {
            background-color: #004080;
        }

        /* --- SEÇÃO DE IMPORTAÇÃO --- */
        .import-controls { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            flex-wrap: wrap;
        }

        #csvFileInput {
            flex-grow: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            padding: 10px 15px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        #importButton { 
            background-color: var(--success-color); 
            color: white; 
        }
        #importButton:hover { 
            background-color: #218838; 
        }

        #clearButton { 
            background-color: var(--danger-color); 
            color: white; 
        }
        #clearButton:hover { 
            background-color: #c82333; 
        }

        #statusMessage {
            font-size: 14px;
            margin-top: 10px;
            color: #555;
        }

        /* --- SEÇÃO DE EXPORTAÇÃO --- */
        .export-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        #exportButton {
            background-color: var(--secondary-color);
            color: white;
        }
        
        #exportButton:hover {
            background-color: #004080;
        }

        /* --- SEÇÃO DE RESUMO --- */
        .summary {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .summary-item {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--box-shadow);
            border-left: 4px solid var(--secondary-color);
        }
        
        .summary-item strong {
            display: block;
            margin-bottom: 5px;
            color: var(--dark-color);
            font-size: 14px;
        }

        .summary-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* --- BARRA DE PESQUISA --- */
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-toggle {
            display: none;
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            margin-bottom: 10px;
            padding: 12px;
            font-size: 16px;
            border-radius: var(--border-radius);
        }
        
        .search-bar { 
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            transition: var(--transition);
        }

        .search-bar input, .search-bar select {
            padding: 12px 15px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            -moz-appearance: textfield;
            width: 100%;
        }
        
        .search-bar input::-webkit-outer-spin-button,
        .search-bar input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* --- RESULTADOS (CARDS) --- */
        #resultsContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .property-card {
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: #fff;
            box-shadow: var(--box-shadow);
            overflow: hidden; 
            transition: var(--transition);
        }
        
        .property-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .property-card-header { 
            background-color: var(--secondary-color); 
            color: white; 
            padding: 12px 15px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .property-card-header h3 { 
            margin: 0; 
            font-size: 18px; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        .property-card-status {
            background-color: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .property-card-body { 
            padding: 15px; 
        }

        .property-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
        }
        .property-details strong { 
            color: #555; 
            font-weight: 600; 
        }
        .property-details span { 
            color: #111; 
            text-align: right; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .no-results {
            font-style: italic;
            color: #777;
            text-align: center;
            width: 100%;
            padding: 30px;
            background-color: #fff;
            border-radius: var(--border-radius);
            grid-column: 1 / -1;
        }
        
        .view-details-btn {
            background-color: var(--primary-color);
            color: white;
            margin-top: 15px;
            width: 100%;
            padding: 12px;
            font-size: 16px;
        }
        .view-details-btn:hover {
            background-color: #c00;
        }

        /* --- ESTILOS: Modal e Ficha --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            padding: 10px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 0 auto;
            padding: 20px;
            border-radius: var(--border-radius);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            width: 100%;
            max-width: 800px;
        }

        .modal-close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: black;
        }
        
        #downloadPdfButton {
            background-color: var(--primary-color);
            color: white;
            margin-top: 20px;
            width: 100%;
            padding: 12px;
            font-size: 16px;
        }
        #downloadPdfButton:hover {
            background-color: #c00;
        }

        /* Estilos da Ficha (dentro do modal) */
        #fichaContent {
            border: 1px solid #eee;
            background: #fff;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        .ficha-header {
            background-color: var(--secondary-color);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .ficha-logo {
            max-width: 120px;
            max-height: 50px;
            object-fit: contain;
        }
        .ficha-header-text {
            flex-grow: 1;
        }
        .ficha-header h2 { 
            margin: 0; 
            font-size: 22px; 
        }
        .ficha-header p { 
            margin: 5px 0 0 0; 
            opacity: 0.9; 
            font-size: 16px; 
        }
        .ficha-status {
            background-color: var(--primary-color);
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .ficha-body { 
            padding: 20px; 
        }
        
        .ficha-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px 20px;
        }
        
        .ficha-item {
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 8px;
        }
        .ficha-item strong {
            font-size: 13px;
            color: #555;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .ficha-item span {
            font-size: 16px;
            color: #111;
            font-weight: 500;
        }
        .ficha-item-full {
            grid-column: 1 / -1;
        }

        /* -------------------------------------------
        --- RESPONSIVIDADE ---
        -------------------------------------------
        */

        /* --- Tablets (até 768px) --- */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header, .config-section, .import-section, .export-section, .summary {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .search-toggle {
                display: block;
            }
            
            .search-bar {
                display: none;
                grid-template-columns: 1fr 1fr;
            }
            
            .search-bar.active {
                display: grid;
            }

            #resultsContainer {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
                margin: 20px auto;
            }

            .ficha-grid {
                grid-template-columns: 1fr;
            }

            .ficha-item-full {
                grid-column: 1 / -1;
            }
            
            .import-controls, .logo-controls {
                flex-direction: column;
            }
            
            .import-controls input,
            .import-controls button,
            .logo-controls input,
            .logo-controls button {
                width: 100%;
            }
        }

        /* --- Celulares (até 480px) --- */
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }

            header, .config-section, .import-section, .export-section, .summary {
                padding: 12px;
            }

            header h1 {
                font-size: 20px;
            }
            
            .search-bar {
                grid-template-columns: 1fr;
            }
            
            .summary {
                flex-direction: column;
            }
            
            .summary-item {
                min-width: 100%;
            }
            
            .property-details {
                grid-template-columns: 1fr;
            }
            
            .property-details span {
                text-align: left;
            }
            
            .export-controls {
                flex-direction: column;
            }
            
            .export-controls button {
                width: 100%;
            }

            .modal-content {
                width: 100%;
                padding: 15px;
                margin: 10px auto;
            }

            .ficha-header {
                padding: 15px;
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .ficha-header h2 {
                font-size: 20px;
            }
            
            .ficha-body {
                padding: 15px;
            }
            
            .ficha-grid {
                gap: 12px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-container">
                    <img id="logoPreview" class="logo-preview" src="" alt="Logo MRV" style="display: none;">
                </div>
                <div class="header-text">
                    <h1>Sistema de Consulta de Imóveis - MRV</h1>
                    <p>Consulta e filtragem de imóveis disponíveis.</p>
                </div>
            </div>
        </header>

        <button class="config-toggle" id="configToggle">Configurações do Sistema</button>

        <div class="config-section" id="configSection">
            <div class="logo-section">
                <h3>Logo da Construtora</h3>
                <p>Carregue a logo da MRV para exibição no sistema e nas fichas PDF.</p>
                <div class="logo-controls">
                    <input type="file" id="logoFileInput" accept="image/*">
                    <button id="logoButton">Carregar Logo</button>
                </div>
                <div id="logoStatusMessage"></div>
            </div>

            <div class="import-section">
                <h3>Importar Dados</h3>
                <p>Selecione um arquivo <strong>.csv, .xls ou .xlsx</strong> para importar ou atualizar os dados.</p>
                <div class="import-controls">
                    <input type="file" id="csvFileInput" accept=".csv, .xls, .xlsx, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
                    <button id="importButton">Importar</button>
                    <button id="clearButton">Limpar Dados Salvos</button>
                </div>
                <div id="statusMessage"></div>
            </div>

            <div class="export-section">
                <h3>Exportar Dados</h3>
                <p>Exporte os dados filtrados para um arquivo CSV.</p>
                <div class="export-controls">
                    <button id="exportButton">Exportar CSV</button>
                </div>
            </div>
        </div>

        <div class="summary" id="summaryContainer">
            <!-- Resumo será preenchido dinamicamente -->
        </div>

        <div class="search-container">
            <button class="search-toggle" id="searchToggle">Mostrar Filtros</button>
            <div class="search-bar" id="searchBar">
                <input type="text" id="searchUnidade" placeholder="Pesquisar por Unidade...">
                <select id="searchCidade">
                    <option value="">Todas as Cidades</option>
                </select>
                <select id="searchTipologia">
                    <option value="">Todas as Tipologias</option>
                </select>
                <select id="searchStatus">
                    <option value="">Todos os Status</option>
                </select>
                <input type="number" id="searchValorMin" placeholder="Valor Mín. (R$)...">
                <input type="number" id="searchValorMax" placeholder="Valor Máx. (R$)...">
                <input type="number" id="searchAreaMin" placeholder="Área Mín. (m²)...">
                <input type="number" id="searchAreaMax" placeholder="Área Máx. (m²)...">
            </div>
        </div>

        <div id="resultsContainer">
            <!-- Resultados serão preenchidos dinamicamente -->
        </div>
    </div>

    <div id="modalContainer" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="modalClose">&times;</span>
            
            <div id="fichaContent">
                <!-- Conteúdo da ficha será preenchido dinamicamente -->
            </div>
            
            <button id="downloadPdfButton">Baixar PDF da Ficha</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Elementos da página
            const searchUnidadeInput = document.getElementById('searchUnidade');
            const searchCidadeSelect = document.getElementById('searchCidade');
            const searchTipologiaSelect = document.getElementById('searchTipologia');
            const searchStatusSelect = document.getElementById('searchStatus');
            const searchValorMinInput = document.getElementById('searchValorMin');
            const searchValorMaxInput = document.getElementById('searchValorMax');
            const searchAreaMinInput = document.getElementById('searchAreaMin');
            const searchAreaMaxInput = document.getElementById('searchAreaMax');
            const resultsContainer = document.getElementById('resultsContainer');
            const summaryContainer = document.getElementById('summaryContainer');
            const csvFileInput = document.getElementById('csvFileInput');
            const importButton = document.getElementById('importButton');
            const clearButton = document.getElementById('clearButton');
            const exportButton = document.getElementById('exportButton');
            const statusMessage = document.getElementById('statusMessage');
            const searchToggle = document.getElementById('searchToggle');
            const searchBar = document.getElementById('searchBar');

            // Elementos do Logo
            const logoFileInput = document.getElementById('logoFileInput');
            const logoButton = document.getElementById('logoButton');
            const logoPreview = document.getElementById('logoPreview');
            const logoStatusMessage = document.getElementById('logoStatusMessage');

            // Elementos de Configuração
            const configToggle = document.getElementById('configToggle');
            const configSection = document.getElementById('configSection');

            // Elementos do Modal
            const modalContainer = document.getElementById('modalContainer');
            const modalClose = document.getElementById('modalClose');
            const fichaContent = document.getElementById('fichaContent');
            const downloadPdfButton = document.getElementById('downloadPdfButton');

            // Banco de dados em memória
            let databaseImoveis = [];
            const STORAGE_KEY = 'sistemaImoveisData';
            const LOGO_STORAGE_KEY = 'sistemaImoveisLogo';
            
            // Referências às bibliotecas externas
            const { jsPDF } = window.jspdf;
            const XLSX = window.XLSX; 

            // --- FUNÇÕES DE UTILIDADE ---

            function removerAcentos(texto) {
                if (!texto) return '';
                return String(texto).normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            }

            function normalizarTexto(texto) {
                return removerAcentos(texto).toLowerCase().trim();
            }

            function limparValorNumerico(valor) {
                if (typeof valor !== 'string' && typeof valor !== 'number') return valor;
                
                let valorString = String(valor);
                
                // Remove todos os pontos de milhar e substitui vírgula decimal por ponto
                valorString = valorString
                    .replace('R$', '')       
                    .replace('m²', '')       
                    .replace(/\./g, '')      
                    .replace(',', '.')       
                    .trim();
                
                // Verifica se é um número válido
                const numero = parseFloat(valorString);
                return isNaN(numero) ? valor : numero;
            }
            
            // CORREÇÃO: Função específica para limpar valores monetários
            function limparValorMonetario(valor) {
                if (typeof valor !== 'string' && typeof valor !== 'number') return valor;
                
                let valorString = String(valor);
                
                // Remove caracteres não numéricos exceto ponto e vírgula
                valorString = valorString
                    .replace('R$', '')
                    .replace(/[^\d,.]/g, '')
                    .trim();
                
                // Se tiver ponto como separador de milhar e vírgula como decimal
                if (valorString.includes('.') && valorString.includes(',')) {
                    // Remove pontos de milhar e substitui vírgula por ponto
                    valorString = valorString.replace(/\./g, '').replace(',', '.');
                } 
                // Se só tiver vírgula (formato brasileiro)
                else if (valorString.includes(',') && !valorString.includes('.')) {
                    // Substitui vírgula por ponto
                    valorString = valorString.replace(',', '.');
                }
                // Se só tiver ponto, assume que já está no formato correto
                
                // Verifica se é um número válido
                const numero = parseFloat(valorString);
                return isNaN(numero) ? valor : numero;
            }
            
            // CORREÇÃO: Função específica para limpar valores de área
            function limparValorArea(valor) {
                if (typeof valor !== 'string' && typeof valor !== 'number') return valor;
                
                let valorString = String(valor);
                
                // Remove caracteres não numéricos exceto ponto e vírgula
                valorString = valorString
                    .replace('m²', '')
                    .replace('m', '')
                    .replace(/[^\d,.]/g, '')
                    .trim();
                
                // Substitui vírgula por ponto para conversão correta
                valorString = valorString.replace(',', '.');
                
                // Verifica se é um número válido
                const numero = parseFloat(valorString);
                return isNaN(numero) ? valor : numero;
            }
            
            function formatarMoeda(valor) {
                const numero = parseFloat(valor);
                if (isNaN(numero)) return 'R$ 0,00';
                return numero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }
            
            function formatarArea(valor) {
                const numero = parseFloat(valor);
                if (isNaN(numero)) return '0 m²';
                
                // CORREÇÃO: Formata com 2 casas decimais para áreas
                const numeroFormatado = numero.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                return `${numeroFormatado} m²`;
            }

            // --- FUNÇÕES DE CONFIGURAÇÃO ---

            configToggle.addEventListener('click', () => {
                configSection.classList.toggle('active');
                configToggle.textContent = configSection.classList.contains('active') ? 
                    'Ocultar Configurações' : 'Configurações do Sistema';
            });

            // --- FUNÇÕES DE LOGO ---

            function loadLogoFromStorage() {
                const logoData = localStorage.getItem(LOGO_STORAGE_KEY);
                if (logoData) {
                    logoPreview.src = logoData;
                    logoPreview.style.display = 'block';
                    logoStatusMessage.textContent = 'Logo carregada do armazenamento local.';
                } else {
                    logoStatusMessage.textContent = 'Nenhuma logo carregada. Por favor, carregue uma logo.';
                }
            }

            logoButton.addEventListener('click', () => {
                const file = logoFileInput.files[0];
                if (!file) {
                    alert('Por favor, selecione um arquivo de imagem primeiro.');
                    return;
                }

                if (!file.type.match('image.*')) {
                    alert('Por favor, selecione um arquivo de imagem válido (JPG, PNG, etc.).');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    const logoData = event.target.result;
                    localStorage.setItem(LOGO_STORAGE_KEY, logoData);
                    logoPreview.src = logoData;
                    logoPreview.style.display = 'block';
                    logoStatusMessage.textContent = 'Logo carregada com sucesso!';
                };
                reader.readAsDataURL(file);
            });

            // --- FUNÇÕES DE DADOS (IMPORTAR, SALVAR, LIMPAR) ---

            function loadDataFromStorage() {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    databaseImoveis = JSON.parse(data);
                    statusMessage.textContent = `${databaseImoveis.length} imóveis carregados do banco de dados local.`;
                    updateFilterOptions();
                    filterImoveis();
                    updateSummary();
                } else {
                    statusMessage.textContent = 'Nenhum dado local encontrado. Por favor, importe um arquivo CSV ou Excel.';
                }
            }

            clearButton.addEventListener('click', () => {
                if (confirm('Tem certeza que deseja apagar todos os dados de imóveis salvos?')) {
                    localStorage.removeItem(STORAGE_KEY);
                    databaseImoveis = [];
                    filterImoveis();
                    updateSummary();
                    statusMessage.textContent = 'Dados locais apagados. Importe um novo arquivo.';
                }
            });

            // --- LÓGICA DE IMPORTAÇÃO (CSV E EXCEL) ---

            importButton.addEventListener('click', () => {
                const file = csvFileInput.files[0];
                if (!file) {
                    alert('Por favor, selecione um arquivo primeiro.');
                    return;
                }

                const reader = new FileReader();
                const fileName = file.name.toLowerCase();

                if (fileName.endsWith('.csv')) {
                    reader.onload = (event) => {
                        const text = event.target.result;
                        processCSV(text); 
                    };
                    reader.readAsText(file, "ISO-8859-1"); 
                
                } else if (fileName.endsWith('.xls') || fileName.endsWith('.xlsx')) {
                    reader.onload = (event) => {
                        const data = event.target.result;
                        processExcel(data); 
                    };
                    reader.readAsArrayBuffer(file);
                
                } else {
                    alert('Formato de arquivo não suportado. Use .csv, .xls ou .xlsx.');
                }
            });

            function processExcel(data) {
                try {
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    const rawDataList = XLSX.utils.sheet_to_json(worksheet, { 
                        raw: false, 
                        defval: "" 
                    });

                    processAndLoadData(rawDataList);

                } catch (error) {
                    console.error('Erro ao processar o arquivo Excel:', error);
                    statusMessage.textContent = 'Erro ao ler o arquivo Excel. Verifique o formato.';
                }
            }
            
            function processCSV(csvText) {
                const lines = csvText.split(/\r\n|\n/);
                if (lines.length < 2) {
                    statusMessage.textContent = 'Erro: CSV vazio ou inválido.';
                    return;
                }
                
                const headers = lines[0].split(';').map(h => h.trim());
                
                const rawDataList = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const data = lines[i].split(';');
                    const rowObject = {};
                    
                    headers.forEach((header, index) => {
                        if (header) { 
                            rowObject[header] = data[index] ? data[index].trim() : '';
                        }
                    });
                    
                    if (Object.keys(rowObject).length > 0) {
                        rawDataList.push(rowObject);
                    }
                }
                
                processAndLoadData(rawDataList);
            }

            function processAndLoadData(rawDataList) {
                const headerMapping = {
                    'regional': 'regional',
                    'cidade': 'cidade',
                    'unidade': 'unidade',
                    'lado nascente': 'ladoNascente',
                    'tipologia': 'tipologia',
                    'area interna': 'areaInterna',
                    'area do quintal': 'areaQuintal',
                    'area da varanda': 'areaVaranda',
                    'tipo de acabamento': 'tipoAcabamento',
                    'status da unidade': 'status',
                    'valor do imovel': 'valorImovel',
                    'vagas carro': 'vagasCarro',
                    'vagas moto': 'vagasMoto',
                    'valor da avaliacao': 'valorAvaliacao',
                    'bom pagador total': 'bomPagador',
                    'pagadoria': 'pagadoria',
                    'bonus': 'bonus',
                    'versao da tabela': 'versaoTabela',
                    'oportunidades abertas': 'oportunidades'
                };
                
                const camposTexto = ['regional', 'cidade', 'unidade', 'ladoNascente', 'tipologia', 'tipoAcabamento', 'status', 'pagadoria'];
                const camposMonetarios = ['valorImovel', 'valorAvaliacao', 'bomPagador']; // CORREÇÃO: Campos monetários separados
                const camposArea = ['areaInterna', 'areaQuintal', 'areaVaranda'];
                
                const newData = [];

                for (const rawRow of rawDataList) {
                    const imovel = {};
                    
                    for (const headerKey in rawRow) {
                        const normalizedHeader = normalizarTexto(headerKey);
                        const internalKey = headerMapping[normalizedHeader]; 
                        
                        if (internalKey) {
                            let value = String(rawRow[headerKey]);
                            
                            if (camposTexto.includes(internalKey)) {
                                value = removerAcentos(value);
                            } else if (camposMonetarios.includes(internalKey)) {
                                // CORREÇÃO: Usa função específica para valores monetários
                                value = limparValorMonetario(value);
                            } else if (camposArea.includes(internalKey)) {
                                value = limparValorArea(value);
                            }
                            
                            imovel[internalKey] = value;
                        }
                    }

                    if (imovel.unidade) {
                        newData.push(imovel);
                    }
                }

                if (newData.length > 0) {
                    databaseImoveis = newData;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(databaseImoveis));
                    statusMessage.textContent = `Sucesso! ${databaseImoveis.length} imóveis importados e salvos localmente.`;
                    updateFilterOptions();
                    filterImoveis();
                    updateSummary();
                } else {
                    statusMessage.textContent = 'Erro: Nenhum dado válido encontrado no arquivo. Verifique o formato e os cabeçalhos.';
                }
            }

            // --- FIM DA LÓGICA DE IMPORTAÇÃO ---

            function updateFilterOptions() {
                searchCidadeSelect.innerHTML = '<option value="">Todas as Cidades</option>';
                searchTipologiaSelect.innerHTML = '<option value="">Todas as Tipologias</option>';
                searchStatusSelect.innerHTML = '<option value="">Todos os Status</option>';
                
                const cidades = [...new Set(databaseImoveis.map(imovel => imovel.cidade))].sort();
                const tipologias = [...new Set(databaseImoveis.map(imovel => imovel.tipologia))].sort();
                const status = [...new Set(databaseImoveis.map(imovel => imovel.status))].sort();
                
                cidades.forEach(cidade => {
                    const option = document.createElement('option');
                    option.value = cidade;
                    option.textContent = cidade;
                    searchCidadeSelect.appendChild(option);
                });
                
                tipologias.forEach(tipologia => {
                    const option = document.createElement('option');
                    option.value = tipologia;
                    option.textContent = tipologia;
                    searchTipologiaSelect.appendChild(option);
                });
                
                status.forEach(estado => {
                    const option = document.createElement('option');
                    option.value = estado;
                    option.textContent = estado;
                    searchStatusSelect.appendChild(option);
                });
            }

            function updateSummary() {
                const totalImoveis = databaseImoveis.length;
                const imoveisDisponiveis = databaseImoveis.filter(imovel => 
                    imovel.status && normalizarTexto(imovel.status) === 'disponivel'
                ).length;
                
                const valorMedio = totalImoveis > 0 ? 
                    databaseImoveis.reduce((sum, imovel) => 
                        sum + (parseFloat(imovel.valorImovel) || 0), 0) / totalImoveis
                    : 0;
                
                summaryContainer.innerHTML = `
                    <div class="summary-item">
                        <strong>Total de Imóveis</strong>
                        <div class="summary-value">${totalImoveis}</div>
                    </div>
                    <div class="summary-item">
                        <strong>Imóveis Disponíveis</strong>
                        <div class="summary-value">${imoveisDisponiveis}</div>
                    </div>
                    <div class="summary-item">
                        <strong>Valor Médio</strong>
                        <div class="summary-value">${formatarMoeda(valorMedio)}</div>
                    </div>
                `;
            }

            // --- FUNÇÕES DE FILTRO E EXIBIÇÃO ---

            function displayResults(imoveis) {
                resultsContainer.innerHTML = ''; 

                if (imoveis.length === 0) {
                    resultsContainer.innerHTML = '<p class="no-results">Nenhum imóvel encontrado para esta combinação de filtros.</p>';
                    return;
                }

                imoveis.forEach(imovel => {
                    const valorImovelFmt = formatarMoeda(imovel.valorImovel);
                    const valorAvaliacaoFmt = formatarMoeda(imovel.valorAvaliacao);
                    
                    const card = document.createElement('div');
                    card.className = 'property-card';
                    
                    card.innerHTML = `
                        <div class="property-card-header">
                            <h3>${imovel.unidade}</h3>
                            <div class="property-card-status">${imovel.status || 'N/D'}</div>
                        </div>
                        <div class="property-card-body">
                            <div class="property-details">
                                <strong>Cidade:</strong>
                                <span>${imovel.cidade || 'N/D'}</span>
                                
                                <strong>Tipologia:</strong>
                                <span>${imovel.tipologia || 'N/D'}</span>

                                <strong>Área Interna:</strong>
                                <span>${formatarArea(imovel.areaInterna)}</span>
                                
                                <strong>Valor do Imóvel:</strong>
                                <span>${valorImovelFmt}</span>
                                
                                <strong>Valor da Avaliação:</strong>
                                <span>${valorAvaliacaoFmt}</span>
                            </div>
                            
                            <button class="view-details-btn" data-id="${imovel.unidade}">Ver Ficha Completa</button>
                        </div>
                    `;
                    resultsContainer.appendChild(card);
                });
            }

            function filterImoveis() {
                const filteredImoveis = getFilteredImoveis();
                displayResults(filteredImoveis);
            }

            // --- FUNÇÕES DE EXPORTAÇÃO ---

            function exportToCSV() {
                if (databaseImoveis.length === 0) {
                    alert('Não há dados para exportar.');
                    return;
                }

                const filteredImoveis = getFilteredImoveis();
                
                if (filteredImoveis.length === 0) {
                    alert('Não há dados filtrados para exportar.');
                    return;
                }

                const headers = [
                    'Regional', 'Cidade', 'Unidade', 'Lado Nascente', 'Tipologia',
                    'Área interna', 'Área do quintal', 'Área da varanda', 'Tipo de acabamento',
                    'Status da unidade', 'Valor do Imóvel', 'Vagas Carro', 'Vagas Moto',
                    'Valor da Avaliação', 'Bom Pagador Total', 'Pagadoria', 'Bônus',
                    'Versao da Tabela', 'Oportunidades abertas'
                ];

                let csvContent = headers.join(';') + '\n';
                
                filteredImoveis.forEach(imovel => {
                    const row = [
                        imovel.regional || '',
                        imovel.cidade || '',
                        imovel.unidade || '',
                        imovel.ladoNascente || '',
                        imovel.tipologia || '',
                        imovel.areaInterna || '',
                        imovel.areaQuintal || '',
                        imovel.areaVaranda || '',
                        imovel.tipoAcabamento || '',
                        imovel.status || '',
                        imovel.valorImovel || '',
                        imovel.vagasCarro || '',
                        imovel.vagasMoto || '',
                        imovel.valorAvaliacao || '',
                        imovel.bomPagador || '',
                        imovel.pagadoria || '',
                        imovel.bonus || '',
                        imovel.versaoTabela || '',
                        imovel.oportunidades || ''
                    ];
                    csvContent += row.join(';') + '\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'imoveis_filtrados.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function getFilteredImoveis() {
                const unidadeQuery = normalizarTexto(searchUnidadeInput.value);
                const cidadeQuery = searchCidadeSelect.value;
                const tipologiaQuery = searchTipologiaSelect.value;
                const statusQuery = searchStatusSelect.value;
                const minValor = parseFloat(searchValorMinInput.value) || 0;
                const maxValor = parseFloat(searchValorMaxInput.value) || Infinity;
                const minArea = parseFloat(searchAreaMinInput.value) || 0;
                const maxArea = parseFloat(searchAreaMaxInput.value) || Infinity;

                if (databaseImoveis.length === 0) {
                    return [];
                }

                return databaseImoveis.filter(imovel => {
                    const valorImovel = parseFloat(imovel.valorImovel) || 0;
                    const areaInterna = parseFloat(imovel.areaInterna) || 0;
                    
                    const matchesUnidade = normalizarTexto(imovel.unidade).includes(unidadeQuery);
                    const matchesCidade = !cidadeQuery || imovel.cidade === cidadeQuery;
                    const matchesTipologia = !tipologiaQuery || imovel.tipologia === tipologiaQuery;
                    const matchesStatus = !statusQuery || imovel.status === statusQuery;
                    const matchesValor = valorImovel >= minValor && valorImovel <= maxValor;
                    const matchesArea = areaInterna >= minArea && areaInterna <= maxArea;
                    
                    return matchesUnidade && matchesCidade && matchesTipologia && matchesStatus && matchesValor && matchesArea;
                });
            }

            // --- FUNÇÕES: MODAL E PDF ---

            function openModal(unidadeId) {
                const imovel = databaseImoveis.find(imv => imv.unidade === unidadeId);
                if (!imovel) {
                    alert('Erro: Imóvel não encontrado.');
                    return;
                }

                const logoData = localStorage.getItem(LOGO_STORAGE_KEY);
                const logoHtml = logoData ? `<img src="${logoData}" class="ficha-logo" alt="Logo MRV">` : '';

                fichaContent.innerHTML = `
                    <div class="ficha-header">
                        ${logoHtml}
                        <div class="ficha-header-text">
                            <h2>${imovel.unidade}</h2>
                            <p>${imovel.tipologia || 'N/D'} - ${imovel.cidade || 'N/D'}</p>
                        </div>
                        <div class="ficha-status">${imovel.status || 'N/D'}</div>
                    </div>
                    <div class="ficha-body">
                        <div class="ficha-grid">
                            <div class="ficha-item">
                                <strong>Valor do Imóvel</strong>
                                <span>${formatarMoeda(imovel.valorImovel)}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Valor da Avaliação</strong>
                                <span>${formatarMoeda(imovel.valorAvaliacao)}</span>
                            </div>

                            <div class="ficha-item">
                                <strong>Área Interna</strong>
                                <span>${formatarArea(imovel.areaInterna)}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Área do Quintal</strong>
                                <span>${formatarArea(imovel.areaQuintal)}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Área da Varanda</strong>
                                <span>${formatarArea(imovel.areaVaranda)}</span>
                            </div>
                            
                            <div class="ficha-item">
                                <strong>Regional</strong>
                                <span>${imovel.regional || 'N/D'}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Lado Nascente</strong>
                                <span>${imovel.ladoNascente || 'N/D'}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Acabamento</strong>
                                <span>${imovel.tipoAcabamento || 'N/D'}</span>
                            </div>
                            
                            <div class="ficha-item">
                                <strong>Vagas Carro</strong>
                                <span>${imovel.vagasCarro || 'N/D'}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Vagas Moto</strong>
                                <span>${imovel.vagasMoto || 'N/D'}</span>
                            </div>
                            
                            <div class="ficha-item">
                                <strong>Bom Pagador</strong>
                                <span>${formatarMoeda(imovel.bomPagador)}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Pagadoria</strong>
                                <span>${imovel.pagadoria || 'N/D'}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Bônus</strong>
                                <span>${imovel.bonus || 'N/D'}</span>
                            </div>
                            
                            <div class="ficha-item">
                                <strong>Versão da Tabela</strong>
                                <span>${imovel.versaoTabela || 'N/D'}</span>
                            </div>
                            <div class="ficha-item">
                                <strong>Oportunidades</strong>
                                <span>${imovel.oportunidades || 'N/D'}</span>
                            </div>
                        </div>
                    </div>
                `;

                modalContainer.style.display = 'block';
                
                downloadPdfButton.onclick = () => downloadPdf(imovel);
            }

            function closeModal() {
                modalContainer.style.display = 'none';
            }

            function downloadPdf(imovel) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                const contentWidth = pageWidth - 2 * margin;
                
                // Cabeçalho moderno com gradiente
                doc.setFillColor(0, 86, 164); // Azul MRV
                doc.rect(0, 0, pageWidth, 60, 'F');
                
                // Logo
                const logoData = localStorage.getItem(LOGO_STORAGE_KEY);
                if (logoData) {
                    try {
                        doc.addImage(logoData, 'PNG', margin, 15, 40, 30);
                    } catch (e) {
                        console.error('Erro ao adicionar logo ao PDF:', e);
                    }
                }
                
                // Título
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text('FICHA DO IMÓVEL', logoData ? margin + 50 : margin, 25);
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text('Sistema de Consulta de Imóveis - MRV', logoData ? margin + 50 : margin, 35);
                
                // Informações principais em destaque
                doc.setTextColor(0, 0, 0);
                doc.setFillColor(245, 245, 245);
                doc.roundedRect(margin, 75, contentWidth, 30, 3, 3, 'F');
                
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text(imovel.unidade, margin + 10, 90);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`${imovel.tipologia || 'N/D'} - ${imovel.cidade || 'N/D'}`, margin + 10, 100);
                
                // Status com badge colorido
                const statusColor = imovel.status && normalizarTexto(imovel.status) === 'disponivel' ? 
                    [40, 167, 69] : [227, 6, 19]; // Vermelho MRV para indisponível
                
                doc.setFillColor(...statusColor);
                doc.roundedRect(pageWidth - margin - 60, 80, 60, 20, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text(imovel.status || 'N/D', pageWidth - margin - 30, 92, { align: 'center' });
                
                // Seções organizadas
                let yPosition = 120;
                
                // Seção 1: Valores
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('VALORES', margin, yPosition);
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, yPosition + 2, margin + 40, yPosition + 2);
                
                yPosition += 10;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Valor do Imóvel: ${formatarMoeda(imovel.valorImovel)}`, margin, yPosition);
                doc.text(`Valor da Avaliação: ${formatarMoeda(imovel.valorAvaliacao)}`, pageWidth/2, yPosition);
                yPosition += 7;
                doc.text(`Bom Pagador: ${formatarMoeda(imovel.bomPagador)}`, margin, yPosition);
                yPosition += 15;
                
                // Seção 2: Áreas
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('ÁREAS', margin, yPosition);
                doc.line(margin, yPosition + 2, margin + 25, yPosition + 2);
                
                yPosition += 10;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Área Interna: ${formatarArea(imovel.areaInterna)}`, margin, yPosition);
                doc.text(`Área do Quintal: ${formatarArea(imovel.areaQuintal)}`, pageWidth/2, yPosition);
                yPosition += 7;
                doc.text(`Área da Varanda: ${formatarArea(imovel.areaVaranda)}`, margin, yPosition);
                yPosition += 15;
                
                // Seção 3: Características
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('CARACTERÍSTICAS', margin, yPosition);
                doc.line(margin, yPosition + 2, margin + 70, yPosition + 2);
                
                yPosition += 10;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Regional: ${imovel.regional || 'N/D'}`, margin, yPosition);
                doc.text(`Lado Nascente: ${imovel.ladoNascente || 'N/D'}`, pageWidth/2, yPosition);
                yPosition += 7;
                doc.text(`Acabamento: ${imovel.tipoAcabamento || 'N/D'}`, margin, yPosition);
                doc.text(`Vagas Carro: ${imovel.vagasCarro || 'N/D'}`, pageWidth/2, yPosition);
                yPosition += 7;
                doc.text(`Vagas Moto: ${imovel.vagasMoto || 'N/D'}`, margin, yPosition);
                yPosition += 15;
                
                // Seção 4: Informações Adicionais
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('INFORMAÇÕES ADICIONAIS', margin, yPosition);
                doc.line(margin, yPosition + 2, margin + 95, yPosition + 2);
                
                yPosition += 10;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Pagadoria: ${imovel.pagadoria || 'N/D'}`, margin, yPosition);
                doc.text(`Bônus: ${imovel.bonus || 'N/D'}`, pageWidth/2, yPosition);
                yPosition += 7;
                doc.text(`Versão da Tabela: ${imovel.versaoTabela || 'N/D'}`, margin, yPosition);
                doc.text(`Oportunidades: ${imovel.oportunidades || 'N/D'}`, pageWidth/2, yPosition);
                
                // Rodapé
                const data = new Date().toLocaleDateString('pt-BR');
                const hora = new Date().toLocaleTimeString('pt-BR');
                
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, doc.internal.pageSize.getHeight() - 20, pageWidth - margin, doc.internal.pageSize.getHeight() - 20);
                
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                doc.text(`Gerado em: ${data} às ${hora}`, margin, doc.internal.pageSize.getHeight() - 10);
                doc.text('Sistema de Consulta de Imóveis - MRV', pageWidth - margin, doc.internal.pageSize.getHeight() - 10, { align: 'right' });
                
                doc.save(`ficha_imovel_${imovel.unidade}.pdf`);
            }

            // --- EVENT LISTENERS ---

            // Filtros
            searchUnidadeInput.addEventListener('input', filterImoveis);
            searchCidadeSelect.addEventListener('change', filterImoveis);
            searchTipologiaSelect.addEventListener('change', filterImoveis);
            searchStatusSelect.addEventListener('change', filterImoveis);
            searchValorMinInput.addEventListener('input', filterImoveis);
            searchValorMaxInput.addEventListener('input', filterImoveis);
            searchAreaMinInput.addEventListener('input', filterImoveis);
            searchAreaMaxInput.addEventListener('input', filterImoveis);

            // Exportação
            exportButton.addEventListener('click', exportToCSV);

            // Modal
            modalClose.addEventListener('click', closeModal);
            window.addEventListener('click', (event) => {
                if (event.target === modalContainer) {
                    closeModal();
                }
            });

            // Event delegation para botões "Ver Ficha Completa"
            resultsContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('view-details-btn')) {
                    const unidadeId = event.target.getAttribute('data-id');
                    openModal(unidadeId);
                }
            });

            // Toggle para filtros em mobile
            searchToggle.addEventListener('click', () => {
                searchBar.classList.toggle('active');
                searchToggle.textContent = searchBar.classList.contains('active') ? 
                    'Ocultar Filtros' : 'Mostrar Filtros';
            });

            // Carregar dados ao iniciar
            loadDataFromStorage();
            loadLogoFromStorage();
        });
    </script>
</body>
</html>
